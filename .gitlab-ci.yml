variables:
  SERVER_DOCKER_FILE: ./Dockerfile
  SERVER_TAG: $CI_REGISTRY_IMAGE:$CI_COMMIT_REF_SLUG

stages:
  - build
  - test
  - reports
  - deploy

# build-tests-image:
#   stage: build
#   rules:
#     - if: $CI_PIPELINE_SOURCE == "pipeline"
#       when: never
#     # run on MR:
#     - if: $CI_PIPELINE_SOURCE == "merge_request_event"
#     # run on main branch
#     - if: $CI_COMMIT_BRANCH == "main"
#   image: docker:latest
#   tags:
#     - saas-linux-small-amd64
#   services:
#     - docker:dind
#   script:
#     - >
#       echo "Docker tag: $SERVER_TAG"
#     - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
#     - docker buildx create --use
#     - docker buildx build --build-arg --platform=linux/amd64,linux/arm64/v8 --push -t $SERVER_TAG .

run-tests:
  stage: test
  image: $SERVER_TAG
  rules:
    # run on MR:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    # run on main branch
    - if: $CI_COMMIT_BRANCH == "main"
  tags:
    - saas-linux-large-amd64
  script: |
    source /root/.local/share/virtualenvs/*/bin/activate
    pytest -n auto --alluredir=allure-results
  allow_failure: true # in case pipeline fails process run
  artifacts:
    when: always
    paths:
      - ./allure-results

allure_job: &allure_job
  stage: reports
  rules:
    # run on MR:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    # run on main branch
    - if: $CI_COMMIT_BRANCH == "main"
  tags:
    - web-ci
  image: frankescobar/allure-docker-service:2.17.2
  script:
    - mkdir -p $(pwd)/allure-report
    - allure generate -c allure-results -o allure-report # from allure-results to allure-report
  artifacts:
    paths:
      - ./allure-results
      - ./allure-report
    expire_in: 30 days

pages:
  rules:
    # run on MR:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    # run on main branch
    - if: $CI_COMMIT_BRANCH == "main"
  stage: deploy
  script:
    - mkdir public
    - mv ./allure-report/* public
  when: manual
  artifacts:
    paths:
      - public
